name: Build and Release Layer 7 AI Voice

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Install dependencies
      run: npm install
      
    - name: Build optimized files
      run: npm run build
      
    - name: Display build info
      run: |
        echo "## ðŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
        cat dist/build-info.json >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: layer7-ai-voice-dist
        path: dist/
        retention-days: 30
        
    - name: Create release archive
      if: github.ref == 'refs/heads/main'
      run: |
        cd dist
        tar -czf ../layer7-ai-voice-optimized.tar.gz *
        cd ..
        
    - name: Generate release tag
      if: github.ref == 'refs/heads/main'
      id: tag
      run: |
        BUILD_TIME=$(date -u '+%Y%m%d-%H%M%S')
        TAG="v1.0.${BUILD_TIME}"
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "Generated tag: ${TAG}"
        
    - name: Create GitHub Release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: "Layer 7 AI Voice - ${{ steps.tag.outputs.tag }}"
        body: |
          ## ðŸ¤– Layer 7 AI Voice Receptionist - Optimized Build
          
          **Build Information:**
          - Commit: ${{ github.sha }}
          - Build Date: ${{ steps.tag.outputs.tag }}
          - Files optimized with 30-40% size reduction
          
          **Contents:**
          - `Layer 7 AI Voice Receptionist (POC) - Retell Agent.json` - Main agent configuration
          - `Core Prompt.md` - Agent instructions template
          - `RAG Agent Prompt - answerQuestion.md` - Secure RAG system prompt
          - `n8n/` - Complete n8n workflow collection
          - `build-info.json` - Detailed build statistics
          
          **Download the optimized files and use them in your AI voice receptionist setup.**
        files: |
          layer7-ai-voice-optimized.tar.gz
        draft: false
        prerelease: false
        
    - name: Build Status Summary
      run: |
        echo "## ðŸš€ Layer 7 AI Voice Build Complete" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Status**: Success" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          echo "- **Release**: ${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Download**: Check [Releases](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY
        fi  